<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéØ Seleccionar n√∫meros</title>

<style>
body{font-family:Arial,sans-serif;background:#f2f2f2;margin:0;padding:15px}
h1{text-align:center}
.card{background:white;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.grid-wrapper{max-height:360px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:8px}
.num{padding:10px;text-align:center;border-radius:6px;background:#e0e0e0;cursor:pointer;font-size:14px}
.num.selected{background:#4CAF50;color:white}
.num.blocked{background:#c62828;color:white;cursor:not-allowed}
.fixed{position:sticky;top:0;background:white;padding-bottom:10px;z-index:10}
button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;font-size:16px}
.primary{background:#4CAF50;color:white}
.secondary{background:#2196F3;color:white}
.disabled{background:#aaa;color:#555}
input{width:100%;padding:10px;margin-top:8px}
.loader{text-align:center;padding:20px;color:#777}
.footer{
  background:#1f2933;
  color:#e5e7eb;
  margin-top:30px;
  padding:22px 15px;
  border-top:4px solid #4CAF50;
}

.footer-content{
  max-width:420px;
  margin:auto;
  text-align:center;
  font-size:13.5px;
  line-height:1.6;
}

.footer-content p{
  margin:6px 0;
}

.footer-copy{
  margin-top:12px;
  font-size:12px;
  color:#9ca3af;
}
</style>
</head>

<body>

<h1>üéØ Selecciona tus n√∫meros</h1>

<div class="card">
  <div class="fixed">
    <p><b>Cantidad requerida:</b> <span id="req"></span></p>
    <p><b>Seleccionados:</b> <span id="sel">0</span></p>
    <input id="buscador" placeholder="Buscar n√∫mero (ej: 0123)">
  </div>

  <div class="grid-wrapper">
    <div id="loader" class="loader">Cargando n√∫meros disponibles‚Ä¶</div>
    <div class="grid" id="lista"></div>
  </div>
</div>

<div class="card">
  <button class="secondary" onclick="completarAzar()">üé≤ Completar al azar</button>
  <button id="continuar" class="disabled" disabled onclick="irCheckout()">Continuar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMKX5fQXRZP-Ic0_Z6yWqD0LBWSn6H2t4",
  authDomain: "rifa-2026-1a341.firebaseapp.com",
  projectId: "rifa-2026-1a341"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const TOTAL = 10000;
const PRECIO = 5000;
const cantidad = Number(localStorage.getItem("cantidad")) || 0;

const lista = document.getElementById("lista");
const req = document.getElementById("req");
const sel = document.getElementById("sel");
const btn = document.getElementById("continuar");
const loader = document.getElementById("loader");
const buscador = document.getElementById("buscador");

req.innerText = cantidad;

let seleccionados = [];
let bloqueados = [];
let disponibles = [];

async function cargarNumeros(){
  const q = query(
    collection(db,"compras"),
    where("estado","in",["pendiente","confirmado"])
  );
  const snap = await getDocs(q);

  snap.forEach(d=>{
    const c = d.data();
    if(Array.isArray(c.numeros)){
      bloqueados.push(...c.numeros);
    }
  });

  for(let i=0;i<TOTAL;i++){
    const n = i.toString().padStart(4,"0");
    if(!bloqueados.includes(n)){
      disponibles.push(n);
    }
  }

  render(disponibles);
}

function render(arr){
  loader.style.display="none";
  lista.innerHTML="";
  arr.forEach(n=>{
    const d=document.createElement("div");
    d.innerText=n;
    d.className="num";
    d.onclick=()=>toggle(n,d);
    lista.appendChild(d);
  });
}

function toggle(n,el){
  if(el.classList.contains("blocked")) return;

  if(el.classList.contains("selected")){
    el.classList.remove("selected");
    seleccionados = seleccionados.filter(x=>x!==n);
  }else{
    if(seleccionados.length>=cantidad) return;
    el.classList.add("selected");
    seleccionados.push(n);
  }
  actualizar();
}

function actualizar(){
  sel.innerText=seleccionados.length;
  if(seleccionados.length===cantidad){
    btn.disabled=false;
    btn.className="primary";
  }else{
    btn.disabled=true;
    btn.className="disabled";
  }
}

window.completarAzar=function(){
  const faltan = cantidad - seleccionados.length;
  if(faltan<=0) return;

  const pool = disponibles.filter(n=>!seleccionados.includes(n));
  for(let i=0;i<faltan;i++){
    const r = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
    seleccionados.push(r);
  }

  document.querySelectorAll(".num").forEach(d=>{
    if(seleccionados.includes(d.innerText)){
      d.classList.add("selected");
    }
  });
  actualizar();
}

buscador.oninput=function(){
  const v = buscador.value.trim();
  if(v===""){ render(disponibles); return; }
  render(disponibles.filter(n=>n.startsWith(v)));
}

window.irCheckout=function(){
  localStorage.setItem("numeros",JSON.stringify(seleccionados));
  localStorage.setItem("cantidad",seleccionados.length);
  localStorage.setItem("total",seleccionados.length*PRECIO);
  location.href="checkout.html";
}

cargarNumeros();
</script>
<footer class="footer">
  <div class="footer-content">
    <p>üéüÔ∏è <b>Rifa privada</b></p>
    <p>
      üîí Los n√∫meros se reservan temporalmente y se asignan por orden de confirmaci√≥n del pago.<br>
      ‚è≥ La validaci√≥n del pago es <b>manual</b>.<br>
      üìß La confirmaci√≥n se env√≠a por <b>correo electr√≥nico y WhatsApp</b>.
    </p>
    <p class="footer-copy">
      ¬© 2026 ¬∑ Todos los derechos reservados
    </p>
  </div>
</footer>
</body>
</html>
